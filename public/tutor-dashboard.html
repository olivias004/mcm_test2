<script>
    document.addEventListener("DOMContentLoaded", async function() {
        console.log("‚úÖ DOM fully loaded and script running");

        // ‚úÖ Ensure Supabase SDK is available before using it
        if (typeof supabase === "undefined") {
            console.log("üîÑ Creating Supabase client...");
            window.supabase = supabase.createClient(
                "https://jvujlqphckklzptnslzz.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dWpscXBoY2trbHpwdG5zbHp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkzMTM5NjMsImV4cCI6MjA1NDg4OTk2M30.Z5202__-uqnWiAJsXZxaCZGgOZXnsER8hq-VzRxiHCQ" // Replace with actual key
            );
        }

        console.log("üîç Supabase initialized:", window.supabase);

        // ‚úÖ Check if Supabase is actually defined
        if (!window.supabase) {
            console.error("‚ùå Supabase failed to initialize!");
            return;
        }

        // ‚úÖ Wait for Supabase to be fully ready before calling auth
        setTimeout(async function() {
            try {
                let { data: user, error } = await window.supabase.auth.getUser();
                if (error || !user) {
                    console.log("‚ùå User is NOT authenticated! Uploads may fail.");
                } else {
                    console.log("‚úÖ User authenticated:", user);
                }
            } catch (err) {
                console.error("‚ùå Error checking user authentication:", err);
            }
        }, 1000); // Small delay to ensure Supabase is initialized

        // ‚úÖ Ensure upload button works
        document.getElementById("upload-homework-btn").addEventListener("click", async () => {
            let statusMsg = document.getElementById("upload-status");
            statusMsg.textContent = "Uploading file...";
            statusMsg.style.color = "blue";

            let selectedClass = document.getElementById("homework-class").value;
            let selectedTerm = document.getElementById("homework-term").value;
            let selectedWeek = document.getElementById("homework-week").value;
            let fileInput = document.getElementById("homework-file");

            if (!fileInput.files.length) {
                statusMsg.textContent = "‚ùå Please select a file to upload!";
                statusMsg.style.color = "red";
                console.log("No file selected.");
                return;
            }

            let file = fileInput.files[0];
            let filePath = `y12/${selectedClass}/${selectedTerm}/${selectedWeek}/${file.name}`;

            console.log("üìÇ Uploading file:", filePath);

            try {
                // ‚úÖ Upload to Supabase Storage
                let { data, error } = await window.supabase.storage.from("Homework").upload(filePath, file, {
                    cacheControl: "3600",
                    upsert: false,
                    contentType: file.type
                });

                if (error) {
                    throw error;
                }

                console.log("‚úÖ File uploaded successfully:", data);

                // ‚úÖ Get Public URL of uploaded file
                let { data: publicUrlData } = window.supabase.storage.from("Homework").getPublicUrl(filePath);
                console.log("üåç Public URL:", publicUrlData.publicUrl);

                // ‚úÖ Save file info in Supabase Database (if needed)
                let { error: dbError } = await window.supabase.from("homework").insert([
                    { 
                        class_id: selectedClass, 
                        term: selectedTerm, 
                        week: selectedWeek, 
                        file_url: publicUrlData.publicUrl 
                    }
                ]);

                if (dbError) {
                    throw dbError;
                }

                statusMsg.textContent = "‚úÖ Homework uploaded successfully!";
                statusMsg.style.color = "green";

            } catch (err) {
                console.error("‚ùå Upload Error:", err);
                statusMsg.textContent = "Error: " + err.message;
                statusMsg.style.color = "red";
            }
        });
    });
</script>
